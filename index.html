<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Real-Time Chat (Admin & Share)</title>
    <!-- Load Tailwind CSS for styling and Inter font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for the messages container */
        #messages-container::-webkit-scrollbar { width: 8px; }
        #messages-container::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        #messages-container::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .chat-container {
            height: 95vh; max-height: 800px; width: 95vw; max-width: 600px;
            display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* Style for the typing indicator dot animation */
        .typing-indicator span { animation: bounce 0.6s infinite alternate; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        /* Base layout */
        body {
            height: 100vh; display: flex; justify-content: center; align-items: center; background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .message-share-link { cursor: pointer; }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Screen/Initial State -->
    <div id="loading-screen" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="text-xl font-semibold text-indigo-600 animate-pulse">
            Initializing Chat System...
        </div>
    </div>

    <!-- Shareable Message View -->
    <div id="share-view" class="chat-container bg-white rounded-xl p-8 shadow-2xl flex flex-col justify-start gap-4 hidden">
        <h2 class="text-3xl font-extrabold text-center text-indigo-600 border-b pb-3">Shared Message</h2>
        <div id="shared-message-content" class="flex-grow overflow-y-auto">
            <!-- Shared message content goes here -->
        </div>
        <button id="close-share-view" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">
            Close and Go to Main Chat
        </button>
    </div>

    <!-- Main Chat Container -->
    <div id="chat-wrapper" class="chat-container bg-white rounded-xl overflow-hidden hidden">
        
        <!-- Header -->
        <header class="p-4 bg-indigo-600 text-white shadow-lg flex justify-between items-center">
            <h1 class="text-xl font-bold">Secure Global Chat <span id="admin-badge" class="hidden bg-red-500 text-xs font-medium py-1 px-2 rounded-full ml-2">ADMIN</span></h1>
            <div id="user-info" class="text-sm flex items-center gap-3">
                <span id="display-name" class="font-semibold"></span>
                <button id="sign-out-button" class="bg-indigo-700 hover:bg-indigo-800 text-xs font-medium py-1 px-3 rounded-full transition duration-150 shadow-inner">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Admin Panel (Conditionally Visible) -->
        <div id="admin-panel" class="p-3 bg-red-100 border-b border-red-300 hidden">
            <p class="text-sm font-semibold text-red-700 mb-2">Admin Tools:</p>
            <div class="flex flex-wrap gap-2 items-center">
                
                <button id="delete-all-messages-btn" class="text-xs bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200">
                    Delete ALL
                </button>

                <label class="flex items-center space-x-2 text-xs text-red-700 cursor-pointer">
                    <input type="checkbox" id="chat-disabled-toggle" class="form-checkbox h-4 w-4 text-red-600 rounded">
                    <span>Disable Chat (Hide)</span>
                </label>
                
                <label class="flex items-center space-x-2 text-xs text-red-700 cursor-pointer">
                    <input type="checkbox" id="chat-locked-toggle" class="form-checkbox h-4 w-4 text-red-600 rounded">
                    <span>Lock Chat (Read-Only)</span>
                </label>
            </div>
        </div>

        <!-- Messages Display Area -->
        <main id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4"></main>

        <!-- Footer / Input Area -->
        <footer id="chat-footer" class="p-4 border-t border-gray-200 bg-gray-50">
            <div id="chat-locked-status" class="text-center text-sm text-red-500 font-semibold mb-2 hidden">
                Chat is currently locked. Only admins can send messages.
            </div>
            <div id="typing-indicator" class="typing-indicator text-sm text-gray-500 mb-2 hidden">
                <span>.</span><span>.</span><span>.</span>
                <span class="ml-1">Someone is typing...</span>
            </div>
            <form id="message-form" class="flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message here..."
                    autocomplete="off"
                    maxlength="500"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 disabled:bg-gray-100 disabled:placeholder-gray-400"
                    required
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50"
                >
                    Send
                </button>
            </form>
        </footer>
    </div>

    <!-- Authentication Form Modal -->
    <div id="auth-modal" class="chat-container bg-white rounded-xl p-8 shadow-2xl flex flex-col justify-center gap-6 hidden">
        <h2 class="text-3xl font-extrabold text-center text-indigo-600">Welcome to Chat!</h2>
        <p id="auth-error-message" class="text-sm text-center text-red-600 hidden"></p>

        <form id="auth-form" class="space-y-4">
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="auth-email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="auth-password" required minlength="6" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="display-name-group" class="hidden">
                <label for="auth-display-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                <input type="text" id="auth-display-name" required maxlength="20" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <button type="submit" id="submit-auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                Sign In
            </button>
        </form>

        <button id="toggle-auth-mode" class="text-sm text-indigo-500 hover:text-indigo-600 transition duration-150">
            Need an account? Switch to Sign Up
        </button>
    </div>

    <!-- Edit Modal (Hidden by default) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Edit Message</h3>
            <textarea id="edit-input" class="w-full h-24 p-3 border border-gray-300 rounded-lg mb-4"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="cancel-edit-button" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-edit-button" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Error/Confirmation Box (No alert() or confirm()) -->
    <div id="custom-alert" class="fixed top-4 right-4 bg-white border border-gray-300 p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform translate-x-full hidden">
        <p id="alert-message" class="text-sm"></p>
        <div class="flex justify-end mt-3 space-x-2 hidden" id="alert-confirm-buttons">
            <button id="alert-cancel" class="text-sm py-1 px-3 bg-gray-200 rounded">Cancel</button>
            <button id="alert-ok" class="text-sm py-1 px-3 bg-red-500 text-white rounded">Confirm</button>
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // =========================================================================
        // FIREBASE SETUP AND IMPORTS
        // =========================================================================
        
        // Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyBs1h6tuFDVN6i_LTxZ3le5rxqcCNZc3E8",
            authDomain: "chatnow-2fff6.firebaseapp.com",
            databaseURL: "https://chatnow-2fff6-default-rtdb.firebaseio.com",
            projectId: "chatnow-2fff6",
            storageBucket: "chatnow-2fff6.firebasestorage.app",
            messagingSenderId: "341859624721",
            appId: "1:341859624721:web:1bf8aa72a18bf2969dcceb0", 
            measurementId: "G-FR4Z8QEH80"
        };

        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            serverTimestamp, 
            query, 
            limitToLast,
            set,
            update,
            remove,
            get,
            child
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const messagesRef = ref(db, 'messages');
        const typingRef = ref(db, 'typing');
        const adminsRef = ref(db, 'Admins');
        const controlsRef = ref(db, 'Controls'); // Path for admin controls
        
        // =========================================================================
        // GLOBAL STATE & DOM ELEMENTS
        // =========================================================================
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const loadingScreen = document.getElementById('loading-screen');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatWrapper = document.getElementById('chat-wrapper');
        const authModal = document.getElementById('auth-modal');
        const displayNameDisplay = document.getElementById('display-name');
        const adminPanel = document.getElementById('admin-panel');
        const adminBadge = document.getElementById('admin-badge');
        const deleteAllMessagesBtn = document.getElementById('delete-all-messages-btn');
        const chatDisabledToggle = document.getElementById('chat-disabled-toggle');
        const chatLockedToggle = document.getElementById('chat-locked-toggle');
        const chatLockedStatus = document.getElementById('chat-locked-status');
        const chatFooter = document.getElementById('chat-footer');
        const shareView = document.getElementById('share-view');
        const sharedMessageContent = document.getElementById('shared-message-content');
        const closeShareViewButton = document.getElementById('close-share-view');
        
        // Edit Modal elements
        const editModal = document.getElementById('edit-modal');
        const editInput = document.getElementById('edit-input');
        const saveEditButton = document.getElementById('save-edit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        
        let currentUserId = null;
        let currentDisplayName = null;
        let isAdmin = false; 
        let isChatDisabled = false; 
        let isChatLocked = false; 
        let editingMessageKey = null; 

        // =========================================================================
        // UTILITY FUNCTIONS & CUSTOM ALERT
        // =========================================================================

        const stringToColor = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        };

        const formatTimestamp = (timestamp, detailed = false) => {
            if (!timestamp) return '...';
            const date = new Date(timestamp);
            if (detailed) {
                return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            }
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };

        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const customAlertElements = {
            customAlert: document.getElementById('custom-alert'),
            alertMessage: document.getElementById('alert-message'),
            alertConfirmButtons: document.getElementById('alert-confirm-buttons'),
            alertOk: document.getElementById('alert-ok'),
            alertCancel: document.getElementById('alert-cancel'),
        };

        const hideAlert = () => {
            customAlertElements.customAlert.classList.add('translate-x-full');
            setTimeout(() => {
                customAlertElements.customAlert.classList.add('hidden');
                customAlertElements.alertConfirmButtons.classList.add('hidden');
            }, 300);
        };

        const showConfirmation = (message, onConfirm) => {
            customAlertElements.alertMessage.textContent = message;
            customAlertElements.alertConfirmButtons.classList.remove('hidden');
            customAlertElements.customAlert.classList.remove('hidden');
            customAlertElements.customAlert.classList.remove('translate-x-full');
            
            const newOk = customAlertElements.alertOk.cloneNode(true);
            const newCancel = customAlertElements.alertCancel.cloneNode(true);
            
            customAlertElements.alertOk.parentNode.replaceChild(newOk, customAlertElements.alertOk);
            customAlertElements.alertCancel.parentNode.replaceChild(newCancel, customAlertElements.alertCancel);
            
            newOk.onclick = () => {
                hideAlert();
                onConfirm();
            };
            newCancel.onclick = hideAlert;
        };
        
        const displayError = (message) => {
            const tempAlert = document.createElement('div');
            tempAlert.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 p-3 rounded-lg shadow-lg z-50 transition-transform duration-300';
            tempAlert.textContent = message;
            document.body.appendChild(tempAlert);
            
            setTimeout(() => {
                tempAlert.classList.add('opacity-0');
                setTimeout(() => tempAlert.remove(), 300);
            }, 5000);
        };

        // =========================================================================
        // ADMIN AND CONTROL LOGIC
        // =========================================================================

        const updateChatControls = (disabled, locked) => {
            set(controlsRef, {
                chatDisabled: disabled,
                chatLocked: locked,
                lastUpdated: serverTimestamp()
            }).catch(e => displayError("Admin Write Error: Could not update chat controls."));
        };

        const handleChatControlUpdate = (controls) => {
            isChatDisabled = controls?.chatDisabled === true;
            isChatLocked = controls?.chatLocked === true;
            
            // Sync Admin UI Toggles (only if current user is admin)
            if (isAdmin) {
                chatDisabledToggle.checked = isChatDisabled;
                chatLockedToggle.checked = isChatLocked;
            }

            // Global UI Update based on disabled/locked state
            if (isChatDisabled && !isAdmin) {
                chatWrapper.classList.add('hidden');
                messagesContainer.innerHTML = '<div class="text-center text-gray-500 mt-10">Chat is currently disabled by admin.</div>';
            } else {
                chatWrapper.classList.remove('hidden');
                
                const sendButton = document.getElementById('send-button');
                
                if (isChatLocked && !isAdmin) {
                    messageInput.disabled = true;
                    messageInput.placeholder = "Chat is locked by admin (Read Only).";
                    sendButton.disabled = true;
                    sendButton.classList.add('disabled:opacity-50');
                    chatLockedStatus.classList.remove('hidden');
                } else {
                    messageInput.disabled = false;
                    messageInput.placeholder = "Type your message here...";
                    sendButton.disabled = false;
                    sendButton.classList.remove('disabled:opacity-50');
                    chatLockedStatus.classList.add('hidden');
                }
            }
        };

        onValue(controlsRef, (snapshot) => {
            handleChatControlUpdate(snapshot.val());
        });

        // Event Listeners for Admin Toggles
        chatDisabledToggle.addEventListener('change', (e) => updateChatControls(e.target.checked, isChatLocked));
        chatLockedToggle.addEventListener('change', (e) => updateChatControls(isChatDisabled, e.target.checked));

        const checkAdminStatus = (uid) => {
            if (!uid) {
                isAdmin = false;
                updateAdminUI();
                return;
            }
            const userAdminRef = ref(db, `Admins/${uid}`);
            onValue(userAdminRef, (snapshot) => {
                isAdmin = snapshot.val() === true;
                updateAdminUI();
                // Re-evaluate chat controls based on new admin status
                onValue(controlsRef, (controlsSnapshot) => handleChatControlUpdate(controlsSnapshot.val()), { onlyOnce: true });
            });
        };

        const updateAdminUI = () => {
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
                adminBadge.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
                adminBadge.classList.add('hidden');
            }
        };

        const deleteAllMessages = () => {
            showConfirmation("Are you sure you want to delete ALL messages? This action is irreversible.", () => {
                if (!isAdmin) {
                    displayError("Permission Denied: You are not an Admin.");
                    return;
                }
                remove(messagesRef)
                    .then(() => displayError("Success: All messages deleted by Admin."))
                    .catch(error => displayError("Error: Could not delete all messages. Check database rules."));
            });
        };
        
        deleteAllMessagesBtn.addEventListener('click', deleteAllMessages);

        // =========================================================================
        // MESSAGE SENDING LOGIC (THE FIX)
        // =========================================================================
        
        const sendMessage = (text) => {
            // Check if chat is locked and the user is not an admin
            if (isChatLocked && !isAdmin) {
                displayError("Chat is currently locked by an admin. You cannot send messages.");
                return;
            }

            const newMessage = {
                uid: currentUserId,
                displayName: currentDisplayName,
                text: text,
                timestamp: serverTimestamp(),
                edited: false
            };

            push(messagesRef, newMessage)
                .then(() => {
                    messageInput.value = ''; // Clear input on success
                    // Also clear typing indicator
                    const userTypingRef = ref(db, `typing/${currentUserId}`);
                    set(userTypingRef, null);
                })
                .catch(error => {
                    console.error("Error sending message:", error);
                    displayError("Error sending message. Check security rules or connection.");
                });
        };

        // Set up the message sending functionality
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault(); // <-- THE CRITICAL FIX: Stops the page refresh

            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text);
            }
        });

        // =========================================================================
        // TYPING INDICATOR LOGIC
        // =========================================================================

        let typingTimeout = null;
        
        const setTypingStatus = (isTyping) => {
            if (!currentUserId) return;
            const userTypingRef = ref(db, `typing/${currentUserId}`);
            // Use currentDisplayName (with UID fallback for safety) for the value
            set(userTypingRef, isTyping ? currentDisplayName : null);
        };
        
        // Input listener for typing status
        messageInput.addEventListener('input', () => {
            // Only update typing status if the user is allowed to chat
            if (isChatLocked && !isAdmin) return;

            if (typingTimeout) clearTimeout(typingTimeout);
            
            if (messageInput.value.length > 0) {
                setTypingStatus(true);
                
                // Clear typing status after a brief delay
                typingTimeout = setTimeout(() => {
                    setTypingStatus(false);
                }, 3000);
            } else {
                 setTypingStatus(false);
            }
        });
        
        // Global listener for other users' typing status
        onValue(typingRef, (snapshot) => {
            const typingUsers = snapshot.val();
            let typists = [];
            
            for (const uid in typingUsers) {
                // Ignore the current user and null entries
                if (uid !== currentUserId && typingUsers[uid]) {
                    typists.push(typingUsers[uid]);
                }
            }

            const typingIndicatorElement = document.getElementById('typing-indicator');
            if (typists.length > 0) {
                const names = typists.slice(0, 2).join(', ');
                const additional = typists.length > 2 ? ` and ${typists.length - 2} others` : '';
                
                document.querySelector('#typing-indicator span:nth-child(4)').textContent = `${names}${additional} is typing...`;
                typingIndicatorElement.classList.remove('hidden');
            } else {
                typingIndicatorElement.classList.add('hidden');
            }
        });
        
        // =========================================================================
        // MESSAGE ACTION HANDLERS (EDIT/DELETE/SHARE)
        // =========================================================================

        const handleDelete = (key) => {
             showConfirmation("Are you sure you want to delete this message?", () => {
                const messageDocRef = ref(db, `messages/${key}`);
                remove(messageDocRef)
                    .then(() => displayError("Message deleted."))
                    .catch(error => displayError("Error deleting message. Check rules."));
            });
        };
        
        const handleShare = (key) => {
            const shareUrl = `${window.location.origin}/?share&type=message&id=${key}`;
            navigator.clipboard.writeText(shareUrl)
                .then(() => displayError("Share link copied to clipboard!"))
                .catch(() => {
                    const tempInput = document.createElement('input');
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    displayError("Share link copied to clipboard! (Fallback)");
                });
        };
        
        // Edit button handlers
        saveEditButton.addEventListener('click', () => {
            const newText = editInput.value.trim();
            if (editingMessageKey && newText) {
                const messageDocRef = ref(db, `messages/${editingMessageKey}`);
                update(messageDocRef, {
                    text: newText,
                    edited: true,
                    timestamp: serverTimestamp() 
                })
                .then(() => {
                    editingMessageKey = null;
                    editModal.classList.add('hidden');
                })
                .catch(error => displayError("Error updating message. Check rules."));
            }
        });

        cancelEditButton.addEventListener('click', () => {
            editingMessageKey = null;
            editModal.classList.add('hidden');
        });


        // Attach global listener for actions
        messagesContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action], span[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const key = target.dataset.key;
            
            if (action === 'edit') {
                const textElement = target.closest('.message-bubble').querySelector('.message-text');
                if (textElement) {
                    editingMessageKey = key;
                    document.getElementById('edit-input').value = textElement.textContent.trim();
                    document.getElementById('edit-modal').classList.remove('hidden');
                }
            } else if (action === 'delete' || action === 'admin-delete') {
                handleDelete(key);
            } else if (action === 'share') {
                handleShare(key);
            }
        });

        // =========================================================================
        // REALTIME DATABASE LOGIC (READING)
        // =========================================================================

        const renderMessage = (key, message) => {
            const isSelf = message.uid === currentUserId;
            const color = stringToColor(message.uid);
            
            // Buttons for user-owned messages (Edit/Delete)
            let userActionsHtml = '';
            if (isSelf) {
                userActionsHtml = `
                    <div class="flex space-x-2 mt-1 opacity-0 group-hover:opacity-100 transition duration-300">
                        <button data-action="edit" data-key="${key}" class="text-xs text-indigo-200 hover:text-white transition duration-150">Edit</button>
                        <button data-action="delete" data-key="${key}" class="text-xs text-red-300 hover:text-red-100 transition duration-150">Delete</button>
                    </div>
                `;
            }
            
            // Admin button to delete ANY message
            let adminDeleteHtml = '';
            if (isAdmin && !isSelf) {
                 adminDeleteHtml = `
                    <button data-action="admin-delete" data-key="${key}" class="absolute top-[-10px] right-[-10px] text-xs bg-red-600 text-white p-1 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition duration-300" title="Admin Delete">
                        &times;
                    </button>
                 `;
            }

            // Share link SVG and span
            const shareLinkHtml = `
                <span data-action="share" data-key="${key}" class="message-share-link text-xs ml-2 opacity-0 group-hover:opacity-100 transition duration-300 cursor-pointer ${isSelf ? 'text-indigo-200 hover:text-white' : 'text-gray-400 hover:text-gray-600'}" title="Copy Share Link">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 inline-block">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.288.677.288 1.093s-.108.77-.288 1.093m0-2.186l9.53-5.035a2.25 2.25 0 0 1 2.22 0l.163.097c.608.337.89.84.89 1.377v4.613m-12.002 0c.18.324.288.677.288 1.093s-.108.77-.288 1.093m0-2.186l-9.53-5.035a2.25 2.25 0 0 0-2.22 0l-.163.097c-.608.337-.89.84-.89 1.377v4.613m12.002 0v5.65m-12.002-5.65v5.65m2.22 0c.18.324.288.677.288 1.093s-.108.77-.288 1.093m0-2.186l-9.53 5.035a2.25 2.25 0 0 1-2.22 0l-.163-.097c-.608-.337-.89-.84-.89-1.377v-4.613m12.002 0c-.18-.324-.288-.677-.288-1.093s.108-.77.288-1.093m0 2.186l9.53-5.035a2.25 2.25 0 0 0 2.22 0l.163-.097c.608-.337.89-.84.89-1.377v-4.613m-12.002 0v-5.65" />
                    </svg>
                </span>
            `;

            return `
                <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs sm:max-w-md message-bubble group flex flex-col ${isSelf ? 'items-end' : 'items-start'}">
                        <div class="relative ${isSelf ? 'bg-indigo-500 text-white' : 'bg-white border border-gray-200 text-gray-800'} p-3 rounded-xl shadow-md ${isSelf ? 'rounded-br-none' : 'rounded-bl-none'} transition duration-150 ease-in-out">
                            ${!isSelf ? 
                                `<p class="text-xs font-bold mb-1" style="color: ${color};">${message.displayName}</p>` 
                                : ''
                            }
                            <p class="message-text text-sm break-words">${message.text}</p>
                            <span 
                                class="text-xs mt-1 block text-right ${isSelf ? 'text-indigo-200' : 'text-gray-400'}"
                                title="${formatTimestamp(message.timestamp, true)}"
                            >
                                ${formatTimestamp(message.timestamp)}
                                ${message.edited ? '<span class="italic ml-1"> (edited)</span>' : ''}
                                ${shareLinkHtml}
                            </span>
                            ${adminDeleteHtml}
                        </div>
                        ${userActionsHtml}
                    </div>
                </div>
            `;
        };

        const setupMessageListener = () => {
            // Check if the user is authenticated before attempting to set up listeners
            if (!currentUserId) return;
            
            const recentMessagesQuery = query(messagesRef, limitToLast(50));
            
            onValue(recentMessagesQuery, (snapshot) => {
                messagesContainer.innerHTML = ''; // Clear existing messages
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const message = childSnapshot.val();
                    messagesContainer.innerHTML += renderMessage(key, message);
                });
                scrollToBottom();
            });
        };
        
        // =========================================================================
        // MESSAGE SHARING LOGIC
        // =========================================================================

        const loadSharedMessage = async (messageId) => {
            loadingScreen.classList.remove('hidden');
            chatWrapper.classList.add('hidden');
            authModal.classList.add('hidden');
            shareView.classList.remove('hidden');
            sharedMessageContent.innerHTML = `<div class="text-center text-gray-500">Loading message...</div>`;
            
            try {
                const snapshot = await get(child(messagesRef, messageId));

                if (snapshot.exists()) {
                    const message = snapshot.val();
                    // Render the single message. Since we don't have auth data in this mode, use a placeholder UID
                    const tempUserId = 'share-viewer-id'; 
                    currentUserId = tempUserId; 
                    currentDisplayName = 'Share Viewer';
                    isAdmin = false;
                    
                    sharedMessageContent.innerHTML = renderMessage(snapshot.key, message);
                } else {
                    sharedMessageContent.innerHTML = `<div class="text-center text-red-500 font-semibold">Message ID: ${messageId} not found.</div>`;
                }
            } catch (error) {
                console.error("Error fetching shared message:", error);
                sharedMessageContent.innerHTML = `<div class="text-center text-red-500 font-semibold">Error loading message.</div>`;
            } finally {
                loadingScreen.classList.add('hidden');
            }
        };

        // Button to close share view and reload main app
        closeShareViewButton.addEventListener('click', () => {
            window.location.search = ''; // Clear URL parameters and reload to main chat view
        });

        // =========================================================================
        // AUTHENTICATION HANDLERS
        // =========================================================================

        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authDisplayName = document.getElementById('auth-display-name');
        const authErrorMessage = document.getElementById('auth-error-message');
        const displayNameGroup = document.getElementById('display-name-group');
        const toggleAuthMode = document.getElementById('toggle-auth-mode');
        let isSignUpMode = false;

        document.getElementById('sign-out-button').addEventListener('click', () => {
            signOut(auth).then(() => {
                displayError("Signed out successfully.");
            }).catch(error => {
                displayError(`Sign out error: ${error.message}`);
            });
        });

        toggleAuthMode.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                toggleAuthMode.textContent = "Already have an account? Switch to Sign In";
                document.getElementById('submit-auth-button').textContent = "Sign Up";
                displayNameGroup.classList.remove('hidden');
            } else {
                toggleAuthMode.textContent = "Need an account? Switch to Sign Up";
                document.getElementById('submit-auth-button').textContent = "Sign In";
                displayNameGroup.classList.add('hidden');
            }
            authErrorMessage.classList.add('hidden');
        });

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            authErrorMessage.classList.add('hidden');

            const email = authEmail.value;
            const password = authPassword.value;
            const displayName = authDisplayName.value || email.split('@')[0];

            let authPromise;

            if (isSignUpMode) {
                authPromise = createUserWithEmailAndPassword(auth, email, password)
                    .then(userCredential => {
                        // Immediately update the profile with the display name
                        return updateProfile(userCredential.user, { displayName: displayName });
                    });
            } else {
                authPromise = signInWithEmailAndPassword(auth, email, password);
            }

            authPromise
                .then(() => {
                    // Handled by onAuthStateChanged
                })
                .catch(error => {
                    let message = "An unknown error occurred.";
                    if (error.code === 'auth/email-already-in-use') {
                        message = "Email already in use. Try signing in.";
                    } else if (error.code === 'auth/invalid-email') {
                        message = "Invalid email format.";
                    } else if (error.code === 'auth/weak-password') {
                        message = "Password should be at least 6 characters.";
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        message = "Invalid email or password.";
                    }
                    authErrorMessage.textContent = message;
                    authErrorMessage.classList.remove('hidden');
                });
        });

        // =========================================================================
        // INITIALIZATION AND MAIN FLOW
        // =========================================================================

        const checkUrlForSharing = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('share') && urlParams.get('type') === 'message' && urlParams.has('id')) {
                loadSharedMessage(urlParams.get('id'));
                return true;
            }
            return false;
        };

        // Only proceed with main chat initialization if not in share mode
        if (!checkUrlForSharing()) {
            // AUTHENTICATION LISTENER
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    currentDisplayName = user.displayName || user.email.split('@')[0];
                    displayNameDisplay.textContent = `Hello, ${currentDisplayName}`;
                    
                    // Essential checks
                    checkAdminStatus(user.uid);
                    
                    authModal.classList.add('hidden');
                    shareView.classList.add('hidden');
                    
                    messagesContainer.innerHTML = '';
                    setupMessageListener();

                } else {
                    currentUserId = null;
                    currentDisplayName = null;
                    isAdmin = false;
                    updateAdminUI(); 
                    
                    chatWrapper.classList.add('hidden');
                    shareView.classList.add('hidden');
                    authModal.classList.remove('hidden');
                    messagesContainer.innerHTML = '<div class="text-center text-gray-500 mt-10">Please sign in to view the chat.</div>';
                }
                loadingScreen.classList.add('hidden');
            });
        }
    </script>
</body>
</html>

