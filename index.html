<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatNow — Global Chat</title>
  <style>
    body {font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:0; background:#f3f4f6;}
    header{background:#111827;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700}
    main{display:flex;gap:16px;padding:16px;max-width:1100px;margin:20px auto}
    .col {background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .chat {flex:1;display:flex;flex-direction:column;height:70vh;min-width:320px}
    /* Fixed: use column instead of column-reverse for message order for better scroll anchoring */
    .messages{flex:1;overflow:auto;padding:8px;gap:8px;display:flex;flex-direction:column}
    .inputRow{display:flex;gap:8px;margin-top:8px}
    input[type="text"]{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px}
    button{padding:8px 10px;border-radius:6px;border:0;background:#0ea5a4;color:#fff;cursor:pointer;transition:background-color .1s}
    button:hover{background:#0d9190}
    .small{font-size:13px;color:#6b7280}
    .adminBadge{background:#fde68a;color:#92400e;padding:2px 6px;border-radius:6px;font-weight:600;margin-left:8px}
    .msg{padding:8px;border-radius:6px;background:#f9fafb;border:1px solid #e6e7eb}
    .msg .meta{font-size:12px;color:#6b7280;margin-bottom:6px;display:flex;align-items:center}
    .msg .body{word-wrap:break-word;overflow-wrap:break-word} /* Added for long messages */
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .danger{background:#ef4444}
    .danger:hover{background:#d43535}
    .muted{background:#9ca3af}
    .muted:hover{background:#8a909a}
    .hidden{display:none}
    footer{padding:12px;text-align:center;color:#6b7280;font-size:13px}
    .banOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;z-index:10} /* Added z-index */
    .adminPanel{min-width:300px;max-width:360px}
    .field{margin-bottom:8px}
    label{display:block;font-size:13px;margin-bottom:4px}
    .userBadge{font-weight:700;color:#0ea5a4}
    /* Added style for the ban overlay message */
    .banOverlay div {padding:20px;background:#ef4444;border-radius:8px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.2)}
  </style>
</head>
<body>
  <header>
    <div class="brand">ChatNow — Global Chat</div>
    <div id="authArea" class="small">
      <span id="userInfo">Not signed in</span>
      <button id="signInBtn">Sign In</button>
      <button id="signUpBtn">Sign Up</button>
      <button id="signOutBtn" class="hidden">Sign Out</button>
    </div>
  </header>

  <main>
    <section class="col chat" id="chatCol">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div>
          <span class="small">Public Global Chat</span>
          <span id="userAdminBadge" class="adminBadge hidden">ADMIN</span>
        </div>
        <div class="small">Status: <span id="statusFlag">ok</span></div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div id="banOverlay" class="banOverlay hidden">
        <div id="banOverlayMessage">
          Function not allowed. Please try again later.
        </div>
      </div>

      <div class="inputRow" id="composer">
        <input id="msgInput" type="text" placeholder="Say something..." maxlength="1000" />
        <button id="sendBtn">Send</button>
      </div>

      <div class="small" style="margin-top:8px">Tip: admins can delete messages, lock/disable chat and ban users.</div>
    </section>

    <aside class="col adminPanel" id="adminPanel" style="min-width:320px">
      <h3>Admin Controls</h3>
      <div id="adminTools" class="hidden">
        <div class="field">
          <label>Search user by UID/email</label>
          <input id="searchUser" type="text" placeholder="UID or email" />
          <div style="margin-top:6px">
            <button id="banBtn" class="danger">Ban user (1 day)</button>
            <button id="unbanBtn" class="muted">Unban user</button>
          </div>
        </div>

        <div class="field">
          <label>Chat state</label>
          <div class="controls">
            <button id="lockBtn">Toggle Lock (only admins may send)</button>
            <button id="disableBtn" class="danger">Toggle Disable (admins only read/write)</button>
            <button id="purgeBtn" class="danger">Purge old messages (30)</button>
          </div>
        </div>

        <div class="field">
          <label>Moderation</label>
          <div class="controls">
            <button id="refreshUsers">Refresh Recent Users</button>
          </div>
          <div id="recentUsers" style="margin-top:8px;max-height:160px;overflow:auto"></div>
        </div>

      </div>

      <div id="notAdmin" class="small">
        Admin tools are only available to verified admins.
      </div>
    </aside>
  </main>

  <footer>Made for demo • Read README for setup instructions</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast, remove, update, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // ----- YOUR FIREBASE CONFIG (from the project you provided) -----
    const firebaseConfig = {
      apiKey: "AIzaSyBs1h6tuFDVN6i_LTxZ3le5rxqcCNZc3E8",
      authDomain: "chatnow-2fff6.firebaseapp.com",
      projectId: "chatnow-2fff6",
      storageBucket: "chatnow-2fff6.firebasestorage.app",
      messagingSenderId: "341859624721",
      appId: "1:341859624721:web:94405372cab65b48dcceb0",
      measurementId: "G-SVCDT7NCPC"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ----- ADMIN LIST (also put same uids in Realtime DB under /admins/{uid}: true) -----
    const KNOWN_ADMIN_UIDS = [];

    // ------------------ References ------------------
    const cfgRef = ref(db, 'config');
    const msgsRef = ref(db, 'messages');
    const adminsRef = ref(db, 'admins');
    const bansRef = ref(db, 'bans');

    // ------------------ UI Elements ------------------
    const userInfoEl = document.getElementById('userInfo');
    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const messagesEl = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('msgInput');
    const adminPanel = document.getElementById('adminPanel');
    const adminTools = document.getElementById('adminTools');
    const notAdmin = document.getElementById('notAdmin');
    const userAdminBadge = document.getElementById('userAdminBadge'); // Renamed from adminBadge to avoid confusion
    const statusFlag = document.getElementById('statusFlag');
    const composer = document.getElementById('composer');
    const banOverlay = document.getElementById('banOverlay');
    const banOverlayMessage = document.getElementById('banOverlayMessage');

    // ------------------ State ------------------
    let currentUser = null;
    let isAdmin = false;
    let chatLocked = false;
    let chatDisabled = false;
    let currentBan = null; // Stored ban object
    let chatReady = false; // Simple flag to ensure everything is loaded

    // ------------------ Utility ------------------
    function el(tag, cls, txt) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (txt) e.textContent = txt;
      return e;
    }

    // Function to update the chat UI based on current state (Auth + Config)
    function updateChatUI() {
      // 1. Update main chat status
      let newStatus = 'ok';
      if (chatDisabled) newStatus = 'disabled';
      else if (chatLocked) newStatus = 'locked';
      else if (currentBan) newStatus = 'banned';
      statusFlag.textContent = newStatus;

      // 2. Control composer visibility
      const canWrite = currentUser && !currentBan && !chatDisabled && (!chatLocked || isAdmin);
      composer.style.display = canWrite ? 'flex' : 'none';

      // 3. Control ban/disable overlay
      if (currentBan) {
        banOverlayMessage.textContent = `You are banned until: ${new Date(currentBan.expires).toLocaleString()}.`;
        banOverlay.classList.remove('hidden');
      }
      else if (chatDisabled && (!currentUser || !isAdmin)) {
        banOverlayMessage.textContent = 'Chat is currently disabled.';
        banOverlay.classList.remove('hidden');
      }
      else {
        banOverlay.classList.add('hidden');
      }
    }

    // ------------------ Auth UI ------------------
    signInBtn.addEventListener('click', async ()=>{
      // Use a custom modal or better prompt/input if this was a production app
      const email = prompt('Email:');
      const pw = prompt('Password:');
      if (!email||!pw) return;
      try{
        await signInWithEmailAndPassword(auth, email, pw);
      }catch(e){ alert('Sign in failed: '+e.message) }
    });

    signUpBtn.addEventListener('click', async ()=>{
      const email = prompt('Email:');
      const pw = prompt('Password (min 6 chars):');
      if (!email||!pw) return;
      try{
        await createUserWithEmailAndPassword(auth, email, pw);
        alert('Account created. You can now sign in.');
      }catch(e){ alert('Sign up failed: '+e.message) }
    });

    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    // ------------------ Auth state ------------------
    onAuthStateChanged(auth, async user=>{
      currentUser = user;
      isAdmin = false;
      currentBan = null; // Reset ban state on auth change

      // Update auth buttons and user info
      if (user){
        userInfoEl.textContent = user.email + ' ('+user.uid.slice(0,8)+')';
        signOutBtn.classList.remove('hidden');
        signInBtn.classList.add('hidden');
        signUpBtn.classList.add('hidden');

        // Check for Admin status
        const adminSnap = await get(ref(db, 'admins/' + user.uid));
        if (KNOWN_ADMIN_UIDS.includes(user.uid) || (adminSnap.exists() && adminSnap.val()===true)){
          isAdmin = true;
          userAdminBadge.classList.remove('hidden');
          adminTools.classList.remove('hidden');
          notAdmin.classList.add('hidden');
        } else {
          userAdminBadge.classList.add('hidden');
          adminTools.classList.add('hidden');
          notAdmin.classList.remove('hidden');
        }

        // Check for Ban status
        const banSnap = await get(ref(db, 'bans/' + user.uid));
        if (banSnap.exists()){
          const ban = banSnap.val();
          if (ban && ban.expires && Date.now() < ban.expires) {
            currentBan = ban; // User is currently banned
          } else {
            // Expired ban: remove it from database
            await remove(ref(db, 'bans/' + user.uid));
          }
        }
      } else {
        // No user signed in
        userInfoEl.textContent = 'Not signed in';
        userAdminBadge.classList.add('hidden');
        adminTools.classList.add('hidden');
        notAdmin.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        signUpBtn.classList.remove('hidden');
      }

      // Important: Update the UI after all async state checks are complete
      updateChatUI();
      chatReady = true;
    });

    // ------------------ Config watchers ------------------
    onValue(cfgRef, snap=>{
      const cfg = snap.val() || {};
      chatLocked = !!cfg.locked;
      chatDisabled = !!cfg.disabled;
      // Use the consolidated function to update UI
      if (chatReady) updateChatUI();
    });

    // ------------------ Message stream ------------------
    // Using simple limitToLast(200) for a basic global chat
    const recentQuery = query(msgsRef, orderByChild('ts'), limitToLast(200));
    onValue(recentQuery, snap=>{
      const data = snap.val()||{};
      messagesEl.innerHTML = '';
      // We sort ascending by timestamp and display them in a standard flow (oldest top, newest bottom)
      // The CSS was updated to remove `flex-direction: column-reverse`
      const keys = Object.keys(data).sort((a,b)=> data[a].ts - data[b].ts);

      keys.forEach(k=>{
        const m = data[k];
        const wrap = el('div','msg');

        // Meta (User name/email and timestamp)
        const meta = el('div','meta');

        // Display user email as the 'user name' and add userBadge class for styling
        const userDisplay = el('span', 'userBadge', m.userName || m.uid.slice(0,8));
        meta.appendChild(userDisplay);
        meta.appendChild(el('span', null, ' • ' + new Date(m.ts).toLocaleString()));

        // Display admin badge next to the user name if they're an admin
        if (m.isAdmin) {
          const ab = el('span','adminBadge','ADMIN');
          meta.appendChild(ab);
        }
        wrap.appendChild(meta);

        // Message body
        const body = el('div','body', m.text);
        wrap.appendChild(body);

        // Admin controls (Delete button)
        if (currentUser && isAdmin) {
          const c = el('div','controls');
          const del = el('button','danger small','Delete');
          del.addEventListener('click', ()=> {
            if (!confirm('Are you sure you want to delete this message?')) return;
            remove(ref(db,'messages/' + k));
          });
          c.appendChild(del);
          wrap.appendChild(c);
        }
        messagesEl.appendChild(wrap);
      });

      // Scroll to bottom only if the user hasn't scrolled up to read history
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });


    // ------------------ Sending messages ------------------
    async function sendMessage() {
      if (!currentUser){ alert('Sign in to send messages'); return; }
      if (chatDisabled && !isAdmin){ alert('Chat disabled'); return; }
      if (chatLocked && !isAdmin){ alert('Chat locked (admins only)'); return; }

      // Re-check ban status on message attempt for immediate feedback
      if (currentBan) {
         alert(`You are banned until: ${new Date(currentBan.expires).toLocaleString()}.`);
         return;
      }

      const text = msgInput.value.trim();
      if (!text) return;

      const newMsgRef = push(msgsRef);
      await set(newMsgRef, {
        uid: currentUser.uid,
        // Using email as the 'userName' for display, which is a common pattern for simple chats
        userName: currentUser.email,
        text,
        ts: Date.now(),
        isAdmin: isAdmin
      });
      msgInput.value = '';
    }

    sendBtn.addEventListener('click', sendMessage);

    // Added: Allow sending message with the Enter key
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // ------------------ Admin actions ------------------
    document.getElementById('lockBtn').addEventListener('click', async ()=>{
      if (!isAdmin) return alert('Admins only');
      await update(cfgRef, { locked: !chatLocked });
    });
    document.getElementById('disableBtn').addEventListener('click', async ()=>{
      if (!isAdmin) return alert('Admins only');
      await update(cfgRef, { disabled: !chatDisabled });
    });

    // Ban/unban via search
    document.getElementById('banBtn').addEventListener('click', async ()=>{
      if (!isAdmin) return alert('Admins only');
      const target = document.getElementById('searchUser').value.trim();
      if (!target) return alert('Enter UID or email');
      let uid = target;

      if (!target.includes('@')) {
         // Assume target is already a UID if it doesn't look like an email
         uid = target;
      } else {
        // Attempt to find user by email in messages (Note: this is an IN-SECURE way to map email to UID.
        // A proper system would use a dedicated user collection in the database.)
        const snap = await get(query(msgsRef, orderByChild('userName'), limitToLast(500)));
        const data = snap.val()||{};
        let found = false;
        for (const k in data) {
          if (data[k].userName === target) { uid = data[k].uid; found = true; break; }
        }
        if (!found) return alert('User not found in recent messages by email. Please provide the UID for direct ban.');
      }
      
      // Add ban for 1 day (86400000 milliseconds)
      const durationHours = 24;
      const expires = Date.now() + durationHours*60*60*1000;
      await set(ref(db,'bans/'+uid), { by: currentUser.uid, expires, reason: `Banned for ${durationHours} hours` });
      alert(`User banned for ${durationHours} hours: ${uid.slice(0,8)}`);
    });

    document.getElementById('unbanBtn').addEventListener('click', async ()=>{
      if (!isAdmin) return alert('Admins only');
      const target = document.getElementById('searchUser').value.trim();
      if (!target) return alert('Enter UID');
      await remove(ref(db,'bans/'+target));
      alert('Unbanned: '+target.slice(0,8));
    });

    document.getElementById('purgeBtn').addEventListener('click', async ()=>{
      if (!isAdmin) return alert('Admins only');
      if (!confirm('WARNING: This will permanently delete old messages. Continue?')) return;

      const keep = 30; // The number of newest messages to keep
      // Order by timestamp ascending to get the oldest messages first
      const snap = await get(query(msgsRef, orderByChild('ts')));
      const data = snap.val()||{};
      const entries = Object.entries(data).sort((a,b)=> a[1].ts - b[1].ts);

      if (entries.length <= keep) return alert('No purge needed. Only ' + entries.length + ' messages exist.');

      // Slice off the oldest messages to be removed
      const toRemove = entries.slice(0, entries.length - keep);
      const updates = {};
      for (const [k] of toRemove) {
        // Prepare a batch delete operation (setting value to null)
        updates['/messages/'+k] = null;
      }
      // Use update at the root to execute all deletions in one go for efficiency
      await update(db.ref(), updates);

      alert(`Purged ${toRemove.length} old messages. Keeping the latest ${keep}.`);
    });


    // simple recent user list
    document.getElementById('refreshUsers').addEventListener('click', async ()=>{
      const snap = await get(query(msgsRef, orderByChild('ts'), limitToLast(200)));
      const data = snap.val()||{};
      const recent = {};
      // Collect unique UID and corresponding userName (email) from recent messages
      Object.values(data).forEach(m=> {
        if (!recent[m.uid]) {
            recent[m.uid] = m.userName; // Use the first userName we find for this UID
        }
      });
      const container = document.getElementById('recentUsers');
      container.innerHTML = '';
      Object.keys(recent).forEach(uid=>{
        const d = el('div',null);
        // Display email (or 'UID-only' if no email was stored, though the current logic sends email)
        const nameSpan = el('span', 'userBadge', recent[uid]);
        const uidSpan = el('span', 'small', ' • ' + uid.slice(0,8));
        d.appendChild(nameSpan);
        d.appendChild(uidSpan);
        container.appendChild(d);
      });
    });

    // initial refresh
    // Wait a bit to ensure admin status is determined before running the refresh
    setTimeout(()=> {
        if (isAdmin) document.getElementById('refreshUsers').click();
    }, 2000);

    // Expose a method to let site owner quickly add admin UID to DB from console:
    window.__promoteToAdmin = async (uid)=> {
      await set(ref(db,'admins/'+uid), true);
      alert('Promoted '+uid);
    };

    // End of module
  </script>
</body>
</html>
