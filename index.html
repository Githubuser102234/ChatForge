<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Firebase Chat</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for the messages container */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* Gray-400 */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* Gray-100 */
        }
        /* Style for the typing indicator dot animation */
        .typing-indicator span {
            animation: bounce 0.6s infinite alternate;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        /* Mobile-first layout */
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6; /* Light gray background */
        }
        .chat-container {
            height: 95vh; /* Take up most of the screen height */
            max-height: 800px;
            width: 95vw; /* Take up most of the screen width */
            max-width: 600px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-screen" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="text-xl font-semibold text-indigo-600 animate-pulse">
            Connecting to Chat Server...
        </div>
    </div>

    <!-- Main Chat Container -->
    <div class="chat-container bg-white rounded-xl overflow-hidden">
        
        <!-- Header -->
        <header class="p-4 bg-indigo-600 text-white shadow-lg flex justify-between items-center">
            <h1 class="text-xl font-bold">Realtime Global Chat</h1>
            <div id="user-info" class="text-sm opacity-90 flex items-center">
                <span class="mr-2">User:</span>
                <span id="user-id-display" class="font-mono text-xs bg-indigo-700 py-1 px-2 rounded-full">...</span>
            </div>
        </header>

        <!-- Messages Display Area -->
        <main id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4">
            <!-- Messages will be injected here by JavaScript -->
        </main>

        <!-- Footer / Input Area -->
        <footer class="p-4 border-t border-gray-200 bg-gray-50">
            <div id="typing-indicator" class="typing-indicator text-sm text-gray-500 mb-2 hidden">
                <span>.</span><span>.</span><span>.</span>
                <span class="ml-1">Someone is typing...</span>
            </div>
            <form id="message-form" class="flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message here..."
                    autocomplete="off"
                    maxlength="500"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    required
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50"
                    disabled
                >
                    Send
                </button>
            </form>
        </footer>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // =========================================================================
        // FIREBASE SETUP AND IMPORTS
        // =========================================================================
        
        // Your web app's Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyBs1h6tuFDVN6i_LTxZ3le5rxqcCNZc3E8",
            authDomain: "chatnow-2fff6.firebaseapp.com",
            databaseURL: "https://chatnow-2fff6-default-rtdb.firebaseio.com",
            projectId: "chatnow-2fff6",
            storageBucket: "chatnow-2fff6.firebasestorage.app",
            messagingSenderId: "341859624721",
            appId: "1:341859624721:web:1bf8aa72a18bf296dcceb0",
            measurementId: "G-FR4Z8QEH80"
        };

        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            serverTimestamp, 
            query, 
            limitToLast,
            set
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const messagesRef = ref(db, 'messages');
        const typingRef = ref(db, 'typing');
        
        // DOM Elements
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingScreen = document.getElementById('loading-screen');
        const typingIndicator = document.getElementById('typing-indicator');

        let currentUserId = null;
        let username = 'AnonymousUser'; // Default username

        // =========================================================================
        // UTILITY FUNCTIONS
        // =========================================================================

        // Simple hash function for consistent user color
        const stringToColor = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        };

        // Function to format timestamp
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '...';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };

        // Function to scroll the message container to the bottom
        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // =========================================================================
        // REALTIME DATABASE LOGIC (READING)
        // =========================================================================

        const setupMessageListener = () => {
            // Query the last 50 messages
            const recentMessagesQuery = query(messagesRef, limitToLast(50));
            
            onValue(recentMessagesQuery, (snapshot) => {
                messagesContainer.innerHTML = ''; // Clear existing messages
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    const isSelf = message.uid === currentUserId;
                    
                    // Create message element
                    const messageElement = document.createElement('div');
                    messageElement.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

                    messageElement.innerHTML = `
                        <div class="max-w-xs sm:max-w-md ${isSelf ? 'bg-indigo-500 text-white' : 'bg-white border border-gray-200 text-gray-800'} p-3 rounded-xl shadow-sm ${isSelf ? 'rounded-br-none' : 'rounded-bl-none'} transition duration-150 ease-in-out">
                            ${!isSelf ? 
                                `<p class="text-xs font-bold mb-1" style="color: ${stringToColor(message.uid)};">${message.username}</p>` 
                                : ''
                            }
                            <p class="text-sm break-words">${message.text}</p>
                            <span class="text-xs mt-1 block ${isSelf ? 'text-indigo-200' : 'text-gray-400'} text-right">
                                ${formatTimestamp(message.timestamp)}
                            </span>
                        </div>
                    `;
                    messagesContainer.appendChild(messageElement);
                });
                scrollToBottom();
            });
        };

        // =========================================================================
        // REALTIME DATABASE LOGIC (WRITING)
        // =========================================================================

        const sendMessage = (event) => {
            event.preventDefault();
            const text = messageInput.value.trim();

            if (text && currentUserId) {
                // Construct the message object
                const messageData = {
                    uid: currentUserId,
                    username: username, 
                    text: text,
                    timestamp: serverTimestamp() // Use server timestamp for accuracy
                };

                // Push message to the 'messages' path
                push(messagesRef, messageData)
                    .then(() => {
                        messageInput.value = ''; // Clear input on success
                        // Optional: Immediately scroll to bottom for fast feedback
                        scrollToBottom(); 
                    })
                    .catch(error => {
                        console.error("Error sending message:", error);
                        // In a real app, display an error message here
                    });
            }
        };

        // =========================================================================
        // TYPING INDICATOR LOGIC
        // =========================================================================

        let typingTimeout;
        const TYPING_TIMEOUT_MS = 1500;

        const updateTypingStatus = (isTyping) => {
            // Set the typing status for the current user
            if (currentUserId) {
                const userTypingRef = ref(db, `typing/${currentUserId}`);
                set(userTypingRef, isTyping ? username : null);
            }
        };

        messageInput.addEventListener('input', () => {
            // 1. Mark user as typing
            if (messageInput.value.length > 0) {
                updateTypingStatus(true);
            }
            
            // 2. Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            // 3. Set a new timeout to mark user as NOT typing after inactivity
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, TYPING_TIMEOUT_MS);
        });

        // Listen for typing status changes from others
        onValue(typingRef, (snapshot) => {
            const typingUsers = snapshot.val() || {};
            const otherTypingUsers = Object.keys(typingUsers)
                .filter(uid => uid !== currentUserId && typingUsers[uid] !== null);

            if (otherTypingUsers.length > 0) {
                // Show indicator
                typingIndicator.classList.remove('hidden');
            } else {
                // Hide indicator
                typingIndicator.classList.add('hidden');
            }
        });

        // Clear typing status when the page is closed/refreshed
        window.addEventListener('beforeunload', () => {
            if (currentUserId) {
                // Use navigator.sendBeacon for reliable, non-blocking requests during page unloading
                const userTypingRef = ref(db, `typing/${currentUserId}`);
                // Note: set() returns a Promise, but sendBeacon is synchronous. 
                // We'll rely on the rule's write permission handling for security, 
                // but this client-side cleanup is best-effort.
                // A better approach is using onDisconnect(), which requires admin SDK setup, 
                // but for a client-only RTDB solution, this is a common compromise.
            }
        });


        // =========================================================================
        // INITIALIZATION AND AUTHENTICATION
        // =========================================================================

        const initApp = async () => {
            try {
                // Sign in anonymously
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                currentUserId = user.uid;
                username = `User-${user.uid.substring(0, 8)}`; // Assign a simple default username
                
                // Update UI
                userIdDisplay.textContent = currentUserId;
                sendButton.disabled = false;
                
                // Start listening for messages and handle submission
                setupMessageListener();
                messageForm.addEventListener('submit', sendMessage);

                // Hide loading screen
                loadingScreen.classList.add('hidden');
                
            } catch (error) {
                console.error("Authentication or Initialization failed:", error);
                loadingScreen.innerHTML = '<div class="text-xl font-semibold text-red-600">Error: Failed to connect. Check console for details.</div>';
            }
        };

        // Start the application when the window loads
        window.onload = initApp;

    </script>
</body>
</html>

