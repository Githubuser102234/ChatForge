<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Auth Real-Time Chat</title>
    <!-- Load Tailwind CSS for styling and Inter font (default by Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for the messages container */
        #messages-container::-webkit-scrollbar { width: 8px; }
        #messages-container::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        #messages-container::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .chat-container {
            height: 95vh; max-height: 800px; width: 95vw; max-width: 600px;
            display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* Style for the typing indicator dot animation */
        .typing-indicator span { animation: bounce 0.6s infinite alternate; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        /* Base layout */
        body {
            height: 100vh; display: flex; justify-content: center; align-items: center; background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Screen/Initial State -->
    <div id="loading-screen" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="text-xl font-semibold text-indigo-600 animate-pulse">
            Initializing Chat System...
        </div>
    </div>

    <!-- Main Chat Container -->
    <div id="chat-wrapper" class="chat-container bg-white rounded-xl overflow-hidden hidden">
        
        <!-- Header -->
        <header class="p-4 bg-indigo-600 text-white shadow-lg flex justify-between items-center">
            <h1 class="text-xl font-bold">Secure Global Chat</h1>
            <div id="user-info" class="text-sm flex items-center gap-3">
                <span id="display-name" class="font-semibold"></span>
                <button id="sign-out-button" class="bg-indigo-700 hover:bg-indigo-800 text-xs font-medium py-1 px-3 rounded-full transition duration-150 shadow-inner">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Messages Display Area -->
        <main id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4"></main>

        <!-- Footer / Input Area -->
        <footer class="p-4 border-t border-gray-200 bg-gray-50">
            <div id="typing-indicator" class="typing-indicator text-sm text-gray-500 mb-2 hidden">
                <span>.</span><span>.</span><span>.</span>
                <span class="ml-1">Someone is typing...</span>
            </div>
            <form id="message-form" class="flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message here..."
                    autocomplete="off"
                    maxlength="500"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    required
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200"
                >
                    Send
                </button>
            </form>
        </footer>
    </div>

    <!-- Authentication Form Modal -->
    <div id="auth-modal" class="chat-container bg-white rounded-xl p-8 shadow-2xl flex flex-col justify-center gap-6 hidden">
        <h2 class="text-3xl font-extrabold text-center text-indigo-600">Welcome to Chat!</h2>
        <p id="auth-error-message" class="text-sm text-center text-red-600 hidden"></p>

        <form id="auth-form" class="space-y-4">
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="auth-email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="auth-password" required minlength="6" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="display-name-group" class="hidden">
                <label for="auth-display-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                <input type="text" id="auth-display-name" required maxlength="20" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <button type="submit" id="submit-auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                Sign In
            </button>
        </form>

        <button id="toggle-auth-mode" class="text-sm text-indigo-500 hover:text-indigo-600 transition duration-150">
            Need an account? Switch to Sign Up
        </button>
    </div>

    <!-- Edit Modal (Hidden by default) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Edit Message</h3>
            <textarea id="edit-input" class="w-full h-24 p-3 border border-gray-300 rounded-lg mb-4"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="cancel-edit-button" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-edit-button" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // =========================================================================
        // FIREBASE SETUP AND IMPORTS
        // =========================================================================
        
        // Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyBs1h6tuFDVN6i_LTxZ3le5rxqcCNZc3E8",
            authDomain: "chatnow-2fff6.firebaseapp.com",
            databaseURL: "https://chatnow-2fff6-default-rtdb.firebaseio.com",
            projectId: "chatnow-2fff6",
            storageBucket: "chatnow-2fff6.firebasestorage.app",
            messagingSenderId: "341859624721",
            appId: "1:341859624721:web:1bf8aa72a18bf296dcceb0",
            measurementId: "G-FR4Z8QEH80"
        };

        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            serverTimestamp, 
            query, 
            limitToLast,
            set,
            update,
            remove
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const messagesRef = ref(db, 'messages');
        const typingRef = ref(db, 'typing');
        
        // =========================================================================
        // GLOBAL STATE & DOM ELEMENTS
        // =========================================================================
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const loadingScreen = document.getElementById('loading-screen');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatWrapper = document.getElementById('chat-wrapper');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const displayNameGroup = document.getElementById('display-name-group');
        const submitAuthButton = document.getElementById('submit-auth-button');
        const authErrorMessage = document.getElementById('auth-error-message');
        const signOutButton = document.getElementById('sign-out-button');
        const displayNameDisplay = document.getElementById('display-name');
        
        // Edit Modal elements
        const editModal = document.getElementById('edit-modal');
        const editInput = document.getElementById('edit-input');
        const saveEditButton = document.getElementById('save-edit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        let currentUserId = null;
        let currentDisplayName = null;
        let isSignUpMode = false;
        let editingMessageKey = null; // Key of the message being edited

        // =========================================================================
        // UTILITY FUNCTIONS
        // =========================================================================

        // Simple hash function for consistent user color
        const stringToColor = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        };

        // Function to format timestamp
        const formatTimestamp = (timestamp, detailed = false) => {
            if (!timestamp) return '...';
            const date = new Date(timestamp);
            if (detailed) {
                return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            }
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };

        // Function to scroll the message container to the bottom
        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const displayError = (message) => {
            authErrorMessage.textContent = message;
            authErrorMessage.classList.remove('hidden');
            setTimeout(() => authErrorMessage.classList.add('hidden'), 5000);
        };

        // =========================================================================
        // AUTHENTICATION LOGIC
        // =========================================================================
        
        toggleAuthModeButton.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                submitAuthButton.textContent = 'Sign Up';
                toggleAuthModeButton.textContent = 'Already have an account? Switch to Sign In';
                displayNameGroup.classList.remove('hidden');
            } else {
                submitAuthButton.textContent = 'Sign In';
                toggleAuthModeButton.textContent = 'Need an account? Switch to Sign Up';
                displayNameGroup.classList.add('hidden');
            }
        });

        authForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = authForm.elements['auth-email'].value;
            const password = authForm.elements['auth-password'].value;
            const displayName = authForm.elements['auth-display-name'].value || email.split('@')[0];

            try {
                if (isSignUpMode) {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Update display name immediately after sign-up
                    await updateProfile(userCredential.user, { displayName: displayName });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let errorMessage = "An unknown error occurred.";
                switch (error.code) {
                    case 'auth/invalid-email': errorMessage = "Invalid email address."; break;
                    case 'auth/user-disabled': errorMessage = "User account disabled."; break;
                    case 'auth/user-not-found': errorMessage = "No user found with this email."; break;
                    case 'auth/wrong-password': errorMessage = "Incorrect password."; break;
                    case 'auth/email-already-in-use': errorMessage = "Email is already in use."; break;
                    case 'auth/weak-password': errorMessage = "Password should be at least 6 characters."; break;
                    default: errorMessage = error.message; break;
                }
                displayError(`Authentication Failed: ${errorMessage}`);
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // =========================================================================
        // MESSAGE ACTION HANDLERS (EDIT/DELETE)
        // =========================================================================

        const handleEdit = (key, currentText) => {
            editingMessageKey = key;
            editInput.value = currentText;
            editModal.classList.remove('hidden');
        };

        const handleDelete = (key) => {
             // Use a custom modal in a real app, but for this single-file demo, we'll use a direct prompt message
            if (confirm("Are you sure you want to delete this message?")) {
                const messageDocRef = ref(db, `messages/${key}`);
                remove(messageDocRef)
                    .then(() => console.log("Message deleted successfully."))
                    .catch(error => console.error("Error deleting message:", error));
            }
        };

        saveEditButton.addEventListener('click', () => {
            const newText = editInput.value.trim();
            if (editingMessageKey && newText) {
                const messageDocRef = ref(db, `messages/${editingMessageKey}`);
                update(messageDocRef, {
                    text: newText,
                    edited: true,
                    timestamp: serverTimestamp() // Update timestamp on edit
                })
                .then(() => {
                    editingMessageKey = null;
                    editModal.classList.add('hidden');
                })
                .catch(error => console.error("Error updating message:", error));
            }
        });

        cancelEditButton.addEventListener('click', () => {
            editingMessageKey = null;
            editModal.classList.add('hidden');
        });

        // Attach global listener for edit/delete buttons
        messagesContainer.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'edit') {
                const key = e.target.dataset.key;
                const textElement = e.target.closest('.message-bubble').querySelector('.message-text');
                if (textElement) {
                    handleEdit(key, textElement.textContent.trim());
                }
            } else if (e.target.dataset.action === 'delete') {
                handleDelete(e.target.dataset.key);
            }
        });

        // =========================================================================
        // REALTIME DATABASE LOGIC (READING)
        // =========================================================================

        const setupMessageListener = () => {
            // Query the last 50 messages
            const recentMessagesQuery = query(messagesRef, limitToLast(50));
            
            onValue(recentMessagesQuery, (snapshot) => {
                messagesContainer.innerHTML = ''; // Clear existing messages
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const message = childSnapshot.val();
                    const isSelf = message.uid === currentUserId;
                    const color = stringToColor(message.uid);
                    
                    // Create message element
                    const messageElement = document.createElement('div');
                    messageElement.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

                    let actionsHtml = '';
                    if (isSelf) {
                        actionsHtml = `
                            <div class="flex space-x-2 mt-1 opacity-0 group-hover:opacity-100 transition duration-300">
                                <button data-action="edit" data-key="${key}" class="text-xs text-indigo-200 hover:text-white transition duration-150">Edit</button>
                                <button data-action="delete" data-key="${key}" class="text-xs text-red-300 hover:text-red-100 transition duration-150">Delete</button>
                            </div>
                        `;
                    }

                    messageElement.innerHTML = `
                        <div class="max-w-xs sm:max-w-md message-bubble group flex flex-col ${isSelf ? 'items-end' : 'items-start'}">
                            <div class="${isSelf ? 'bg-indigo-500 text-white' : 'bg-white border border-gray-200 text-gray-800'} p-3 rounded-xl shadow-md ${isSelf ? 'rounded-br-none' : 'rounded-bl-none'} transition duration-150 ease-in-out relative">
                                ${!isSelf ? 
                                    `<p class="text-xs font-bold mb-1" style="color: ${color};">${message.displayName}</p>` 
                                    : ''
                                }
                                <p class="message-text text-sm break-words">${message.text}</p>
                                <span 
                                    class="text-xs mt-1 block text-right ${isSelf ? 'text-indigo-200' : 'text-gray-400'}"
                                    title="${formatTimestamp(message.timestamp, true)}"
                                >
                                    ${formatTimestamp(message.timestamp)}
                                    ${message.edited ? '<span class="italic ml-1"> (edited)</span>' : ''}
                                </span>
                            </div>
                            ${actionsHtml}
                        </div>
                    `;
                    messagesContainer.appendChild(messageElement);
                });
                scrollToBottom();
            });
        };

        // =========================================================================
        // REALTIME DATABASE LOGIC (WRITING & TYPING)
        // =========================================================================

        const sendMessage = (event) => {
            event.preventDefault();
            const text = messageInput.value.trim();

            if (text && currentUserId) {
                const messageData = {
                    uid: currentUserId,
                    displayName: currentDisplayName, 
                    text: text,
                    timestamp: serverTimestamp(),
                    edited: false
                };

                push(messagesRef, messageData)
                    .then(() => {
                        messageInput.value = ''; 
                        updateTypingStatus(false); // Clear typing status after sending
                        scrollToBottom(); 
                    })
                    .catch(error => {
                        console.error("Error sending message:", error);
                    });
            }
        };

        messageForm.addEventListener('submit', sendMessage);


        let typingTimeout;
        const TYPING_TIMEOUT_MS = 1500;

        const updateTypingStatus = (isTyping) => {
            if (currentUserId) {
                const userTypingRef = ref(db, `typing/${currentUserId}`);
                set(userTypingRef, isTyping ? currentDisplayName : null);
            }
        };

        messageInput.addEventListener('input', () => {
            if (messageInput.value.length > 0) {
                updateTypingStatus(true);
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, TYPING_TIMEOUT_MS);
        });

        // Listen for typing status changes from others
        onValue(typingRef, (snapshot) => {
            const typingUsers = snapshot.val() || {};
            const otherTypingUsers = Object.keys(typingUsers)
                .filter(uid => uid !== currentUserId && typingUsers[uid] !== null);

            if (otherTypingUsers.length > 0) {
                typingIndicator.querySelector('span:last-child').textContent = `${otherTypingUsers.join(', ')} is typing...`;
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        });

        // =========================================================================
        // MAIN APPLICATION FLOW: AUTH STATE LISTENER
        // =========================================================================

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                currentDisplayName = user.displayName || user.email.split('@')[0]; // Fallback to email prefix
                displayNameDisplay.textContent = `Hello, ${currentDisplayName}`;
                
                // Show chat, hide auth
                authModal.classList.add('hidden');
                chatWrapper.classList.remove('hidden');

                // Clear and set up chat listeners
                messagesContainer.innerHTML = '';
                setupMessageListener();

            } else {
                // User is signed out
                currentUserId = null;
                currentDisplayName = null;
                
                // Show auth, hide chat
                chatWrapper.classList.add('hidden');
                authModal.classList.remove('hidden');
                loadingScreen.classList.add('hidden'); // Ensure loading screen is hidden when auth is shown
                messagesContainer.innerHTML = '<div class="text-center text-gray-500 mt-10">Please sign in to view the chat.</div>';

                // Clear typing status on sign out
                if (currentUserId) { updateTypingStatus(false); }
            }
            loadingScreen.classList.add('hidden'); // Hide loading screen after initial check
        });

        // Initial check to hide loading screen if listener already fired
        window.onload = () => {
             // If onAuthStateChanged hasn't fired yet, it will hide the screen later.
             // Otherwise, this ensures it's hidden immediately.
             if (auth.currentUser === null && chatWrapper.classList.contains('hidden')) {
                loadingScreen.classList.add('hidden');
             }
        };

    </script>
</body>
</html>

