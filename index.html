<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Real-Time Chat (Admin)</title>
    <!-- Load Tailwind CSS for styling and Inter font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for the messages container */
        #messages-container::-webkit-scrollbar { width: 8px; }
        #messages-container::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        #messages-container::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .chat-container {
            height: 95vh; max-height: 800px; width: 95vw; max-width: 600px;
            display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* Style for the typing indicator dot animation */
        .typing-indicator span { animation: bounce 0.6s infinite alternate; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        /* Base layout */
        body {
            height: 100vh; display: flex; justify-content: center; align-items: center; background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Screen/Initial State -->
    <div id="loading-screen" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="text-xl font-semibold text-indigo-600 animate-pulse">
            Initializing Chat System...
        </div>
    </div>

    <!-- Main Chat Container -->
    <div id="chat-wrapper" class="chat-container bg-white rounded-xl overflow-hidden hidden">
        
        <!-- Header -->
        <header class="p-4 bg-indigo-600 text-white shadow-lg flex justify-between items-center">
            <h1 class="text-xl font-bold">Secure Global Chat <span id="admin-badge" class="hidden bg-red-500 text-xs font-medium py-1 px-2 rounded-full ml-2">ADMIN</span></h1>
            <div id="user-info" class="text-sm flex items-center gap-3">
                <span id="display-name" class="font-semibold"></span>
                <button id="sign-out-button" class="bg-indigo-700 hover:bg-indigo-800 text-xs font-medium py-1 px-3 rounded-full transition duration-150 shadow-inner">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Admin Panel (Conditionally Visible) -->
        <div id="admin-panel" class="p-3 bg-red-100 border-b border-red-300 hidden">
            <p class="text-sm font-semibold text-red-700 mb-2">Admin Tools:</p>
            <button id="delete-all-messages-btn" class="text-xs bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200">
                Delete ALL Messages (Requires Admin Privileges)
            </button>
        </div>

        <!-- Messages Display Area -->
        <main id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4"></main>

        <!-- Footer / Input Area -->
        <footer class="p-4 border-t border-gray-200 bg-gray-50">
            <div id="typing-indicator" class="typing-indicator text-sm text-gray-500 mb-2 hidden">
                <span>.</span><span>.</span><span>.</span>
                <span class="ml-1">Someone is typing...</span>
            </div>
            <form id="message-form" class="flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message here..."
                    autocomplete="off"
                    maxlength="500"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    required
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200"
                >
                    Send
                </button>
            </form>
        </footer>
    </div>

    <!-- Authentication Form Modal -->
    <div id="auth-modal" class="chat-container bg-white rounded-xl p-8 shadow-2xl flex flex-col justify-center gap-6 hidden">
        <h2 class="text-3xl font-extrabold text-center text-indigo-600">Welcome to Chat!</h2>
        <p id="auth-error-message" class="text-sm text-center text-red-600 hidden"></p>

        <form id="auth-form" class="space-y-4">
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="auth-email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="auth-password" required minlength="6" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="display-name-group" class="hidden">
                <label for="auth-display-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                <input type="text" id="auth-display-name" required maxlength="20" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <button type="submit" id="submit-auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                Sign In
            </button>
        </form>

        <button id="toggle-auth-mode" class="text-sm text-indigo-500 hover:text-indigo-600 transition duration-150">
            Need an account? Switch to Sign Up
        </button>
    </div>

    <!-- Edit Modal (Hidden by default) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Edit Message</h3>
            <textarea id="edit-input" class="w-full h-24 p-3 border border-gray-300 rounded-lg mb-4"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="cancel-edit-button" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-edit-button" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Error Box (No alert() or confirm()) -->
    <div id="custom-alert" class="fixed top-4 right-4 bg-white border border-gray-300 p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform translate-x-full hidden">
        <p id="alert-message" class="text-sm"></p>
        <div class="flex justify-end mt-3 space-x-2 hidden" id="alert-confirm-buttons">
            <button id="alert-cancel" class="text-sm py-1 px-3 bg-gray-200 rounded">Cancel</button>
            <button id="alert-ok" class="text-sm py-1 px-3 bg-red-500 text-white rounded">Confirm</button>
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // =========================================================================
        // FIREBASE SETUP AND IMPORTS
        // =========================================================================
        
        // Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyBs1h6tuFDVN6i_LTxZ3le5rxqcCNZc3E8",
            authDomain: "chatnow-2fff6.firebaseapp.com",
            databaseURL: "https://chatnow-2fff6-default-rtdb.firebaseio.com",
            projectId: "chatnow-2fff6",
            storageBucket: "chatnow-2fff6.firebasestorage.app",
            messagingSenderId: "341859624721",
            appId: "1:341859624721:web:1bf8aa72a18bf2969dcceb0", // Corrected the trailing d-2969dcceb0 instead of 296dcceb0 from previous
            measurementId: "G-FR4Z8QEH80"
        };

        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            serverTimestamp, 
            query, 
            limitToLast,
            set,
            update,
            remove
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const messagesRef = ref(db, 'messages');
        const typingRef = ref(db, 'typing');
        const adminsRef = ref(db, 'Admins'); // Reference to the Admins list
        
        // =========================================================================
        // GLOBAL STATE & DOM ELEMENTS
        // =========================================================================
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const loadingScreen = document.getElementById('loading-screen');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatWrapper = document.getElementById('chat-wrapper');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const displayNameDisplay = document.getElementById('display-name');
        const adminPanel = document.getElementById('admin-panel');
        const adminBadge = document.getElementById('admin-badge');
        const deleteAllMessagesBtn = document.getElementById('delete-all-messages-btn');
        
        // Edit Modal elements
        const editModal = document.getElementById('edit-modal');
        const editInput = document.getElementById('edit-input');
        const saveEditButton = document.getElementById('save-edit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        // Custom Alert/Confirmation elements (replacing window.confirm/alert)
        const customAlert = document.getElementById('custom-alert');
        const alertMessage = document.getElementById('alert-message');
        const alertConfirmButtons = document.getElementById('alert-confirm-buttons');
        const alertOk = document.getElementById('alert-ok');
        const alertCancel = document.getElementById('alert-cancel');
        
        let currentUserId = null;
        let currentDisplayName = null;
        let isSignUpMode = false;
        let editingMessageKey = null; // Key of the message being edited
        let isAdmin = false; // New state variable

        // =========================================================================
        // UTILITY FUNCTIONS (Timestamp, Color, Scroll)
        // =========================================================================

        const stringToColor = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        };

        const formatTimestamp = (timestamp, detailed = false) => {
            if (!timestamp) return '...';
            const date = new Date(timestamp);
            if (detailed) {
                return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            }
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };

        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // Custom Alert/Confirmation Box
        const showConfirmation = (message, onConfirm) => {
            alertMessage.textContent = message;
            alertConfirmButtons.classList.remove('hidden');
            customAlert.classList.remove('hidden');
            customAlert.classList.remove('translate-x-full');
            
            // Clone and replace buttons to ensure fresh event listeners
            const newOk = alertOk.cloneNode(true);
            const newCancel = alertCancel.cloneNode(true);
            
            alertOk.parentNode.replaceChild(newOk, alertOk);
            alertCancel.parentNode.replaceChild(newCancel, alertCancel);
            
            newOk.onclick = () => {
                hideAlert();
                onConfirm();
            };
            newCancel.onclick = hideAlert;
        };

        const hideAlert = () => {
            customAlert.classList.add('translate-x-full');
            setTimeout(() => {
                customAlert.classList.add('hidden');
                alertConfirmButtons.classList.add('hidden');
            }, 300);
        };
        
        const displayError = (message) => {
            const tempAlert = document.getElementById('custom-alert-temp') || document.createElement('div');
            tempAlert.id = 'custom-alert-temp';
            tempAlert.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 p-3 rounded-lg shadow-lg z-50 transition-transform duration-300';
            tempAlert.textContent = message;
            document.body.appendChild(tempAlert);
            
            setTimeout(() => {
                tempAlert.classList.add('opacity-0');
                setTimeout(() => tempAlert.remove(), 300);
            }, 5000);
        };

        // =========================================================================
        // ADMIN LOGIC
        // =========================================================================

        const checkAdminStatus = (uid) => {
            if (!uid) {
                isAdmin = false;
                updateAdminUI();
                return;
            }
            // Listen to the specific admin status for the current user
            const userAdminRef = ref(db, `Admins/${uid}`);
            onValue(userAdminRef, (snapshot) => {
                // If the value is true, the user is an admin
                isAdmin = snapshot.val() === true;
                updateAdminUI();
            });
        };

        const updateAdminUI = () => {
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
                adminBadge.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
                adminBadge.classList.add('hidden');
            }
        };

        const deleteAllMessages = () => {
            showConfirmation("Are you sure you want to delete ALL messages? This action is irreversible.", () => {
                remove(messagesRef)
                    .then(() => {
                        displayError("Success: All messages deleted by Admin.");
                    })
                    .catch(error => {
                        console.error("Admin Delete All Error:", error);
                        displayError("Error: Could not delete all messages. Check database rules.");
                    });
            });
        };
        
        deleteAllMessagesBtn.addEventListener('click', deleteAllMessages);

        // =========================================================================
        // MESSAGE ACTION HANDLERS (EDIT/DELETE)
        // =========================================================================

        const handleEdit = (key, currentText) => {
            editingMessageKey = key;
            editInput.value = currentText;
            editModal.classList.remove('hidden');
        };

        const handleDelete = (key) => {
             showConfirmation("Are you sure you want to delete this message?", () => {
                const messageDocRef = ref(db, `messages/${key}`);
                remove(messageDocRef)
                    .then(() => displayError("Message deleted."))
                    .catch(error => {
                        console.error("Error deleting message:", error);
                        displayError("Error deleting message. Check rules.");
                    });
            });
        };

        saveEditButton.addEventListener('click', () => {
            const newText = editInput.value.trim();
            if (editingMessageKey && newText) {
                const messageDocRef = ref(db, `messages/${editingMessageKey}`);
                update(messageDocRef, {
                    text: newText,
                    edited: true,
                    timestamp: serverTimestamp() // Update timestamp on edit
                })
                .then(() => {
                    editingMessageKey = null;
                    editModal.classList.add('hidden');
                })
                .catch(error => displayError("Error updating message. Check rules."));
            }
        });

        cancelEditButton.addEventListener('click', () => {
            editingMessageKey = null;
            editModal.classList.add('hidden');
        });

        // Attach global listener for edit/delete buttons
        messagesContainer.addEventListener('click', (e) => {
            // Traverse up to find the action button
            const target = e.target.closest('button[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const key = target.dataset.key;
            
            if (action === 'edit') {
                const textElement = target.closest('.message-bubble').querySelector('.message-text');
                if (textElement) {
                    handleEdit(key, textElement.textContent.trim());
                }
            } else if (action === 'delete' || action === 'admin-delete') {
                handleDelete(key);
            }
        });

        // =========================================================================
        // REALTIME DATABASE LOGIC (READING)
        // =========================================================================

        const setupMessageListener = () => {
            const recentMessagesQuery = query(messagesRef, limitToLast(50));
            
            onValue(recentMessagesQuery, (snapshot) => {
                messagesContainer.innerHTML = ''; // Clear existing messages
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const message = childSnapshot.val();
                    const isSelf = message.uid === currentUserId;
                    const color = stringToColor(message.uid);
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

                    // Buttons for user-owned messages (Edit/Delete)
                    let userActionsHtml = '';
                    if (isSelf) {
                        userActionsHtml = `
                            <div class="flex space-x-2 mt-1 opacity-0 group-hover:opacity-100 transition duration-300">
                                <button data-action="edit" data-key="${key}" class="text-xs text-indigo-200 hover:text-white transition duration-150">Edit</button>
                                <button data-action="delete" data-key="${key}" class="text-xs text-red-300 hover:text-red-100 transition duration-150">Delete</button>
                            </div>
                        `;
                    }
                    
                    // Admin button to delete ANY message
                    let adminDeleteHtml = '';
                    if (isAdmin && !isSelf) {
                         adminDeleteHtml = `
                            <button data-action="admin-delete" data-key="${key}" class="absolute top-[-10px] right-[-10px] text-xs bg-red-600 text-white p-1 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition duration-300" title="Admin Delete">
                                &times;
                            </button>
                         `;
                    }


                    messageElement.innerHTML = `
                        <div class="max-w-xs sm:max-w-md message-bubble group flex flex-col ${isSelf ? 'items-end' : 'items-start'}">
                            <div class="relative ${isSelf ? 'bg-indigo-500 text-white' : 'bg-white border border-gray-200 text-gray-800'} p-3 rounded-xl shadow-md ${isSelf ? 'rounded-br-none' : 'rounded-bl-none'} transition duration-150 ease-in-out">
                                ${!isSelf ? 
                                    `<p class="text-xs font-bold mb-1" style="color: ${color};">${message.displayName}</p>` 
                                    : ''
                                }
                                <p class="message-text text-sm break-words">${message.text}</p>
                                <span 
                                    class="text-xs mt-1 block text-right ${isSelf ? 'text-indigo-200' : 'text-gray-400'}"
                                    title="${formatTimestamp(message.timestamp, true)}"
                                >
                                    ${formatTimestamp(message.timestamp)}
                                    ${message.edited ? '<span class="italic ml-1"> (edited)</span>' : ''}
                                </span>
                                ${adminDeleteHtml}
                            </div>
                            ${userActionsHtml}
                        </div>
                    `;
                    messagesContainer.appendChild(messageElement);
                });
                scrollToBottom();
            });
        };

        // =========================================================================
        // MAIN APPLICATION FLOW: AUTH STATE LISTENER
        // =========================================================================

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                currentDisplayName = user.displayName || user.email.split('@')[0];
                displayNameDisplay.textContent = `Hello, ${currentDisplayName}`;
                
                // --- ADMIN CHECK ---
                checkAdminStatus(user.uid);
                
                // Show chat, hide auth
                authModal.classList.add('hidden');
                chatWrapper.classList.remove('hidden');

                // Clear and set up chat listeners
                messagesContainer.innerHTML = '';
                setupMessageListener();

            } else {
                // User is signed out
                currentUserId = null;
                currentDisplayName = null;
                isAdmin = false; // Reset admin status
                updateAdminUI(); // Hide admin panel
                
                // Show auth, hide chat
                chatWrapper.classList.add('hidden');
                authModal.classList.remove('hidden');
                loadingScreen.classList.add('hidden');
                messagesContainer.innerHTML = '<div class="text-center text-gray-500 mt-10">Please sign in to view the chat.</div>';

                // Clear typing status on sign out (best effort)
                const userTypingRef = ref(db, `typing/${currentUserId}`);
                set(userTypingRef, null);
            }
            loadingScreen.classList.add('hidden');
        });

    </script>
</body>
</html>

